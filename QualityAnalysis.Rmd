---
title: "Quality Analysis"
author: "Lauren Bradley"
date: "11/9/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


#Focus Demographics. 

Demographics
Sex/Gender
Age
Race/Ethnicity
Obesity


Chronic diseases
Type 2 diabetes mellitus/Metabolic syndrome
Atherosclerosis
Hypertension
Obesity


Markers
Type 2 diabetes mellitus markers
Glycosylated hemoglobin (Hba1c)
Oral glucose tolerance test
Adiponectin
Glycated albumin
Fructosamine

Metabolic syndrome markers
Waist circumference: >35 inches for females; >40 inches for males
Body mass index: >30 kg/m2 for females and males
Fasting plasma glucose: >100 mg/dL or previously diagnosed type 2 diabetes mellitus
Elevated Triglycerides: >150 mg/dL for females and males
Decreased high density lipoprotein cholesterol (HDL-C): <50 mg/dL for females, <40 mg/dL for males 
Hypertension: Systolic blood pressure: ≥130 mm Hg, Diastolic blood pressure: ≥85 mm Hg

Cardiovascular disease markers
Total cholesterol (TC)
High density lipoprotein cholesterol (HDL-C)
Low density lipoprotein cholesterol (LDL-C)
Triglycerides (TG)
C-reactive Protein (CRP)
Interleukin-6 (IL-6)



Import data

```{r}
load("C:/Users/laure/git/capstone/NHANESCleanFactors.RData")
df_full <- subset(df_full, select = -c(BMIHEAD))

```



Cleaning added according to quality analysis:

```{r}
df_full$DID040[df_full$DID040 == 666 | df_full$DID040 == 999] <- NA
df_full$DIQ010[df_full$DIQ010 == 3 | df_full$DIQ010 == 7 | df_full$DIQ010 == 9] <- 2
df_full$DIQ010[is.na(df_full$DIQ010)] <- 2
```

Determining if people are obese:

```{r}
is_obese_bmi <- c()
for (item in df_full$BMXBMI){
  if (is.na(item)){
    is_obese_bmi <- append(is_obese_bmi, NA)
  }
  else if (item > 30){
    is_obese_bmi <- append(is_obese_bmi, "1")
  }
  else{
    is_obese_bmi <- append(is_obese_bmi, "2")
  }
}

df_full$OBS_BMI <- is_obese_bmi
```

Regression (age vs age when got diabetes)

```{r}
mod <- lm(DID040 ~ RIDAGEYR,data = df_full)
plot(df_full$RIDAGEYR, df_full$DID040)
abline(mod)
```


```{r}
par(mfrow=c(1,3))
plot(mod$fitted.values, mod$residuals, main = "Residual Scatter Plot")
abline(h = 0)

qqnorm(mod$residuals)

hist(mod$residuals)
```





# Try to make a line plot with proportions of whether someone says yes or noo to something

```{r}
# subset dfs by each year
df0910 <- df_full[df_full$Year == "2009-2010",]
df1112 <- df_full[df_full$Year == "2011-2012",]
df1314 <- df_full[df_full$Year == "2013-2014",]
df1516 <- df_full[df_full$Year == "2015-2016",]
df1718 <- df_full[df_full$Year == "2017-2018",]

```

```{r}
dia_prop <- c()
dia_prop <- append(dia_prop,
                  table(df0910$DIQ010)[1]/dim(df0910)[1])
dia_prop <- append(dia_prop,
                  table(df1112$DIQ010)[1]/dim(df1112)[1])
dia_prop <- append(dia_prop, 
                  table(df1314$DIQ010)[1]/dim(df1314)[1])
dia_prop <- append(dia_prop,
                  table(df1516$DIQ010)[1]/dim(df1516)[1])
dia_prop <- append(dia_prop,
                  table(df1718$DIQ010)[1]/dim(df1718)[1])

```


```{r}
library(ggplot2)

prop_df <- data.frame("Year" = c("2009-2010", 
                                 "2011-2012",
                                 "2013-2014",
                                 "2015-2016",
                                 "2017-2018"),
                      "DIA_Prop" = dia_prop)

ggplot(prop_df, aes(x = Year, y = DIA_Prop, group = 1)) + geom_point() + geom_path() + ylab("Diabetes Proportion") + theme_bw() + ggtitle("Diabetes Proportion vs. Year")
```


# Now looking at coronary heart disease

```{r}
heart_prop <- c()
heart_prop <- append(heart_prop,
                  table(df0910$MCQ160B)[1]/dim(df0910)[1])
heart_prop <- append(heart_prop,
                  table(df1112$MCQ160B)[1]/dim(df1112)[1])
heart_prop <- append(heart_prop, 
                  table(df1314$MCQ160B)[1]/dim(df1314)[1])
heart_prop <- append(heart_prop,
                  table(df1516$MCQ160B)[1]/dim(df1516)[1])
heart_prop <- append(heart_prop,
                  table(df1718$MCQ160B)[1]/dim(df1718)[1])

prop_df$HEART_prop <- heart_prop
```

```{r}
ggplot(prop_df, aes(x = Year, y = HEART_prop, group = 1)) + geom_point() + geom_path() + ylab("Congestive Heart Disease Proportion") + theme_bw() + ggtitle("Congestive Heart Disease Proportion vs. Year")

```


```{r}
obs_prop <- c()
obs_prop <- append(obs_prop,
                  table(df0910$BMXBMI)[1]/dim(df0910)[1])
obs_prop <- append(obs_prop,
                  table(df1112$BMXBMI)[1]/dim(df1112)[1])
obs_prop <- append(obs_prop, 
                  table(df1314$BMXBMI)[1]/dim(df1314)[1])
obs_prop <- append(obs_prop,
                  table(df1516$BMXBMI)[1]/dim(df1516)[1])
obs_prop <- append(obs_prop,
                  table(df1718$BMXBMI)[1]/dim(df1718)[1])
prop_df$OBS_prop <- obs_prop
```

```{r}
ggplot(prop_df, aes(x = Year, y = OBS_prop, group = 1)) + geom_point() + geom_path() + ylab("Obesity based on BMI Proportion") + theme_bw() + ggtitle("Obesity vs. Year")
```




# Target Variables
DIQ010

```{r}
one_val <- c()
col_names <- names(df_full)
for (i in 1:length(df_full)){
  if (length(table(df_full[i])) == 1){
    one_val <- col_names[i]
  }
}
```



```{r}
#df_sub <- df_full[,-which(names(df_full) %in% one_val)]

#df_full <- subset(df_full, select = -c(BMIHEAD))
#df_full$DIQ010 <- as.factor(df_full$DIQ010)
null_model <- glm(DIQ010 ~ 1, data = df_full, family = "binomial")
full_model <- glm(DIQ010 ~ ., data = df_full, family = "binomial")
model_step_AIC <- step(null_model,
                       scope = list(lower = null_model, upper = full_model),
                       direction="forward", k = 2, trace = 0)
summary(model_step_AIC)


str(df_full)

```

```{r}
# df_full$DIQ010 <- droplevels(df_full$DIQ010, except = c(1,2))
ggplot(df_full, aes(x=DIQ010, y=RIDAGEYR)) + 
  geom_boxplot() + xlab("Diabetes? 1 - Yes, 2 - No") + ylab("Age") + ggtitle("Age vs. Diabetes")

```

```{r}
ggplot(df_full, aes(x=DIQ010, y=RIDAGEYR)) + 
  geom_boxplot() + xlab("Diabetes? 1 - Yes, 2 - No") + ylab("Age") + ggtitle("Age vs. Diabetes")
```






# Checking for how many null values there are and putting it into a table. 
```{r}
col_names <- names(df_full)
prop_null <- c()
for (i in 1:length(col_names)){
  null_prop <- sum(is.na(df_full[i]))/dim(df_full[i])[1]
  prop_null <- append(prop_null, null_prop)
}

null_df <- data.frame("VariableName" = col_names, "NullProportion" = prop_null)
null_df
```

```{r}
# Available variables
available <- (1 - null_df$NullProportion)*dim(df_full)[1]
null_df$Available <- available
```


```{r}
save(null_df, file = "PropNullDF.RData")
```


# Box plot of null values
```{r}
library(ggplot2)
null_boxplot <- ggplot(null_df, aes(x = "", y = NullProportion)) + 
  geom_boxplot() + xlab("") + ylab("Summary") + ggtitle("Null Proportions of Variables Summary")
```

```{r}
num <- null_df$Available[null_df$Available > 3000]
length(num)
```
```{r}
avail_boxplot <- ggplot(null_df, aes(x = "", y = Available)) + 
  geom_boxplot() + xlab("") + ylab("Summary") + ggtitle("Availability of Observations within Variables Summary")
```

```{r}
ggsave("avail_boxplot.pdf",avail_boxplot)
ggsave("null_boxplot.pdf",null_boxplot)
```


```{r}
number_df <- df_full[,sapply(df_full,is.numeric)]
cor(number_df)

unique(number_df)

```
# -------------------------MODELING--------------


```{r}
table(df_full$DIQ010)
str(df_full$DIQ010)

```
```{r}
col_greater_10000 <- null_df$VariableName[null_df$Available > 10000]

selected_df <- subset(df_full, select = c(col_greater_3000))

```

```{r}
library(tidyverse)
predictorSet <- c("DIQ010", "RIDAGEYR", "RIAGENDR", "BMXBMI")

# Including everything from selected_df results in 0
selected_df %>% 
  select(one_of(names(selected_df))) %>% 
  na.omit() %>% 
  nrow()

#selected_df %>% 
#  select(one_of(names(selected_df))) %>% 
#  na.omit() %>% 
#  nrow()
```

```{r}
mod1 <- glm(DIQ010 ~ 
              RIDAGEYR + 
              RIAGENDR + 
              BMXBMI, data = selected_df, family = "binomial")
summary(mod1)
```


```{r}
str(selected_df)
str(selected_df[95:dim(selected_df)[2]])
str(selected_df[150:dim(selected_df)[2]])
#selected_df <- subset(selected_df, select = -c(Year))
#for (item in 1:length(names(selected_df))){
#  if (!is.numeric(selected_df[item])){
#    print("HI")
#    print(names(selected_df)[item])
#    print(table(selected_df[item]))
#  }
 
#}

selected_df <- subset(selected_df, select = -c(SEQN))


  
```


```{r}
null_model <- glm(DIQ010 ~ 1, data = selected_df, family = "binomial")
full_model <- glm(DIQ010 ~ , data = selected_df, family = "binomial")
model_step_AIC <- step(null_model,
                       scope = list(lower = null_model, upper = full_model),
                       direction="forward", k = 2, trace = 0)
summary(model_step_AIC)

```

```{r}
save(selected_df, file = "selected_df.RData")
```




# What I think is wrong

- The 1 and 2s needs to be a factor type
- there are still 3/9/7s in the data sets for some reason

# Things that can be nice for quality analysis

- proportions and compare by year


# Instead of cleaning, try to combine the variables that are the same at the front. 


